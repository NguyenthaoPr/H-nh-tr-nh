
<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>B·∫£n ƒë·ªì h√†nh tr√¨nh ‚Äì ti·ªán d·ª•ng</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
  html, body, #map {height:100%; margin:0}
  .legend{
    position:fixed; bottom:12px; left:12px; background:#fff; border-radius:10px;
    box-shadow:0 4px 14px rgba(0,0,0,.15); padding:10px 12px; font:14px/1.3 system-ui,-apple-system,Segoe UI,Roboto;
  }
  .legend .dot{display:inline-block; width:12px; height:12px; border-radius:50%; margin-right:6px; vertical-align:middle}
  .topbar{
    position:fixed; top:10px; left:50%; transform:translateX(-50%);
    background:#fff; border-radius:999px; box-shadow:0 4px 14px rgba(0,0,0,.15);
    padding:8px 12px; font:14px system-ui,-apple-system,Segoe UI,Roboto;
    display:flex; gap:8px; align-items:center; z-index:1000
  }
  .btn{
    border:0; padding:8px 12px; border-radius:999px; background:#0b74ff; color:#fff;
    font-weight:600; cursor:pointer
  }
  .btn:disabled{opacity:.6; cursor:not-allowed}
  /* S·ªë th·ª© t·ª± marker */
  .num-marker{
    background:#fff; border:2px solid #1a1a1a; width:28px; height:28px; border-radius:50%;
    text-align:center; line-height:24px; font:700 14px/24px system-ui,-apple-system,Segoe UI,Roboto;
    box-shadow:0 2px 6px rgba(0,0,0,.25)
  }
  .popup{
    min-width:220px; font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto;
  }
  .popup h4{margin:.25rem 0 .35rem 0}
  .popup .meta{opacity:.75; margin-bottom:.25rem}
  .popup .actions{margin-top:.35rem; display:flex; gap:6px; flex-wrap:wrap}
  .chip{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background:#f4f6fb; font-size:12px}
  .chip .dot{width:10px;height:10px;border-radius:50%}
</style>
</head>
<body>
<div id="map"></div>

<div class="topbar">
  <button class="btn" id="locateBtn">üìç ƒê·ªãnh v·ªã</button>
  <button class="btn" id="fitBtn">üó∫Ô∏è Xem to√†n tuy·∫øn</button>
</div>

<div class="legend" id="legend"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ===== D·ªÆ LI·ªÜU H√ÄNH TR√åNH (theo ng√†y) =====
const days = [
  {day:'Ng√†y 1', color:'#1e90ff', stops:[
    {name:'Ph∆∞·ªùng B√†n Th·∫°ch - ƒê√† N·∫µng', lat:15.975, lng:108.249},
    {name:'S√¢n bay ƒê√† N·∫µng', lat:16.043, lng:108.199},
    {name:'S√¢n bay N·ªôi B√†i', lat:21.214, lng:105.802},
    {name:'T√¢n Tr√†o - Tuy√™n Quang', lat:21.957, lng:105.181},
    {name:'Nghƒ©a trang li·ªát sƒ© V·ªã Xuy√™n', lat:22.827, lng:104.933},
  ]},
  {day:'Ng√†y 2', color:'#2ecc71', stops:[
    {name:'C·ªïng Tr·ªùi Qu·∫£n B·∫°', lat:23.017, lng:105.004},
    {name:'C·ªôt c·ªù L≈©ng C√∫', lat:23.364, lng:105.318},
    {name:'Dinh th·ª± h·ªç V∆∞∆°ng', lat:23.282, lng:105.262},
    {name:'Ch·ª£ ƒê·ªìng VƒÉn', lat:23.283, lng:105.285},
  ]},
  {day:'Ng√†y 3', color:'#e74c3c', stops:[
    {name:'S√¥ng Nho Qu·∫ø', lat:23.199, lng:105.305},
    {name:'M√£ P√≠ L√®ng', lat:23.215, lng:105.247},
    {name:'M√®o V·∫°c', lat:23.151, lng:105.418},
    {name:'Hang P√°c B√≥', lat:22.853, lng:106.362},
    {name:'Su·ªëi L√™ Nin', lat:22.857, lng:106.364},
    {name:'N√∫i C√°c M√°c', lat:22.858, lng:106.365},
    {name:'M·ªô Kim ƒê·ªìng', lat:22.725, lng:106.411},
  ]},
  {day:'Ng√†y 4', color:'#9b59b6', stops:[
    {name:'Th√°c B·∫£n D·ªëc', lat:22.856, lng:106.722},
    {name:'Ch·ª£ T√¢n Thanh', lat:21.888, lng:106.742},
  ]},
  {day:'Ng√†y 5', color:'#f39c12', stops:[
    {name:'ƒê·ªông Tam Thanh', lat:21.854, lng:106.757},
  ]},
];

// ===== KH·ªûI T·∫†O B·∫¢N ƒê·ªí =====
const map = L.map('map').setView([21.5, 105.5], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19, attribution: '&copy; OpenStreetMap'
}).addTo(map);

const groups = {};   // L.layerGroup theo t·ª´ng ng√†y
const bounds = [];   // ch·ª©a t·∫•t c·∫£ to·∫° ƒë·ªô ƒë·ªÉ fitBounds

function numIcon(n){
  return L.divIcon({html:`<div class="num-marker">${n}</div>`, iconSize:[28,28], className:''});
}

// H√†m m·ªü Google Maps d·∫´n ƒë∆∞·ªùng ƒë·∫øn lat,lng (∆∞u ti√™n d√πng v·ªã tr√≠ th·∫≠t)
function openDirections(lat, lng){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const {latitude, longitude} = pos.coords;
      const url = `https://www.google.com/maps/dir/?api=1&origin=${latitude},${longitude}&destination=${lat},${lng}`;
      window.open(url, '_blank');
    }, _err=>{
      const fallback = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&origin=Current+Location`;
      window.open(fallback, '_blank');
    }, {timeout:5000});
  }else{
    window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&origin=Current+Location`, '_blank');
  }
}

// V·∫Ω t·ª´ng ng√†y
let globalIndex = 1;
days.forEach(d => {
  const g = L.layerGroup().addTo(map);
  groups[d.day] = g;

  const dayLatLngs = [];
  d.stops.forEach((s, idx) => {
    const m = L.marker([s.lat, s.lng], {icon:numIcon(globalIndex++)}).addTo(g);
    dayLatLngs.push([s.lat, s.lng]);
    bounds.push([s.lat, s.lng]);

    const popup = document.createElement('div');
    popup.className = 'popup';
    popup.innerHTML = `
      <h4>${s.name}</h4>
      <div class="meta"><span class="chip"><span class="dot" style="background:${d.color}"></span>${d.day}</span> ¬∑ ƒêi·ªÉm #${idx+1}</div>
      <div class="actions">
        <button class="btn" onclick="openDirections(${s.lat},${s.lng})">üß≠ M·ªü Google Maps</button>
        <a class="btn" style="text-decoration:none;background:#6c757d" target="_blank"
           href="https://www.google.com/maps/search/?api=1&query=${s.lat},${s.lng}">üîé Xem tr√™n Maps</a>
      </div>
    `;
    m.bindPopup(popup);
  });

  // polyline theo ng√†y
  L.polyline(dayLatLngs, {color:d.color, weight:3, opacity:0.85}).addTo(g);
});

// Layer control (b·∫≠t/t·∫Øt t·ª´ng ng√†y)
L.control.layers(null, groups, {collapsed:false}).addTo(map);

// Fit to√†n tuy·∫øn l√∫c m·ªü
map.fitBounds(bounds);

// Legend
const legend = document.getElementById('legend');
legend.innerHTML = days.map(d => `<div><span class="dot" style="background:${d.color}"></span>${d.day}</div>`).join('');

// N√∫t ƒë·ªãnh v·ªã
document.getElementById('locateBtn').onclick = () => {
  if (!navigator.geolocation) { alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.'); return; }
  navigator.geolocation.getCurrentPosition(pos => {
    const {latitude, longitude} = pos.coords;
    const ll = [latitude, longitude];
    L.marker(ll, {title:'V·ªã tr√≠ c·ªßa t√¥i'}).addTo(map).bindPopup('üìç V·ªã tr√≠ c·ªßa t√¥i').openPopup();
    map.setView(ll, 13);
  }, err => {
    alert('Kh√¥ng truy c·∫≠p ƒë∆∞·ª£c v·ªã tr√≠. Vui l√≤ng b·∫≠t quy·ªÅn ƒë·ªãnh v·ªã cho tr√¨nh duy·ªát.');
  });
};

// N√∫t xem to√†n tuy·∫øn
document.getElementById('fitBtn').onclick = () => map.fitBounds(bounds);
</script>
</body>
</html>
